import numpy as np
import pytest
from rice_ml.supervised_learning.multilayer_perceptron import MultilayerPerceptron


@pytest.fixture
def simple_binary_data():
    X = np.array([
        [0.0, 0.0],
        [0.0, 1.0],
        [1.0, 0.0],
        [1.0, 1.0],
    ])
    y = np.array([0, 1, 1, 0])  # XOR
    return X, y


def test_fit_and_predict(simple_binary_data):
    X, y = simple_binary_data
    model = MultilayerPerceptron(
        hidden_layers=[4],
        learning_rate=0.5,
        max_iter=5000,
        random_state=0,
    )
    model.fit(X, y)
    preds = model.predict(X)
    assert set(preds).issubset({0, 1})


def test_accuracy_on_xor(simple_binary_data):
    X, y = simple_binary_data
    model = MultilayerPerceptron(
        hidden_layers=[8],
        learning_rate=0.5,
        max_iter=8000,
        random_state=0,
    )
    model.fit(X, y)
    acc = model.score(X, y)
    assert acc >= 0.95


def test_predict_before_fit_raises():
    model = MultilayerPerceptron(hidden_layers=[4])
    X = np.array([[0.0, 0.0]])

    with pytest.raises(TypeError):
        model.predict(X)


def test_invalid_labels():
    X = np.array([[0], [1], [2]])
    y = np.array([0, 1, 2])

    model = MultilayerPerceptron(hidden_layers=[4])

    with pytest.raises(ValueError):
        model.fit(X, y)
